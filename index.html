<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InkCost Pro - Calculadora de Tatuajes</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Animaciones */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos de Impresión */
        @media print {
            body * { visibility: hidden; }
            #report-modal, #report-modal * { visibility: visible; }
            #report-modal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding: 0; overflow: visible; }
            #report-content { box-shadow: none; border: none; max-width: 100%; width: 100%; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.560.0"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm no-print">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2 shrink-0">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-md shadow-indigo-200">IC</div>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight hidden sm:block">InkCost Pro</h1>
            </div>

            <div class="flex p-1 bg-slate-100/80 rounded-lg border border-slate-200">
                <button onclick="switchTab('calculator')" id="btn-tab-calc" class="flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 bg-white text-indigo-600 shadow-sm ring-1 ring-black/5">
                    <i data-lucide="calculator" class="w-4 h-4"></i>
                    <span>Calculadora</span>
                </button>
                <button onclick="switchTab('supplies')" id="btn-tab-supplies" class="flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all duration-200 text-slate-500 hover:text-slate-700">
                    <i data-lucide="package" class="w-4 h-4"></i>
                    <span>Insumos</span>
                </button>
            </div>

            <div class="shrink-0 text-xs text-slate-400 font-medium hidden md:block">by @dr.velazquez</div>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="max-w-5xl mx-auto px-4 py-6 w-full flex-1">
        
        <!-- VISTA CALCULADORA -->
        <div id="view-calculator" class="space-y-6 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Inputs -->
                <div class="space-y-6">
                    <!-- Tiempo -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                            <h3 class="text-lg font-semibold text-slate-800">Tiempo y Mano de Obra</h3>
                            <p class="text-sm text-slate-500 mt-0.5">Lo más importante: tu tiempo</p>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1.5 flex items-center gap-1.5">
                                        <i data-lucide="dollar-sign" class="w-3.5 h-3.5"></i> Valor Hora
                                    </label>
                                    <input type="number" id="inp-hourly-rate" oninput="calculate()" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-medium text-lg">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1.5 flex items-center gap-1.5">
                                        <i data-lucide="clock" class="w-3.5 h-3.5"></i> Minutos
                                    </label>
                                    <input type="number" id="inp-minutes" value="0" oninput="calculate()" class="w-full px-4 py-2.5 bg-indigo-50 border border-indigo-200 rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-indigo-700 text-lg">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insumos Variables -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                            <h3 class="text-lg font-semibold text-slate-800">Insumos Variables</h3>
                            <p class="text-sm text-slate-500 mt-0.5">Solo lo que cambia por sesión</p>
                        </div>
                        <div class="p-6 space-y-5">
                            
                            <!-- Tinta -->
                            <div class="flex items-center gap-4 group">
                                <div class="w-12 h-12 rounded-xl bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-400">
                                    <i data-lucide="droplets" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="text-sm font-semibold text-slate-700 mb-1 block">Dosis de Tinta</label>
                                    <input type="number" id="inp-tinta" value="1" min="0" oninput="calculate()" class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500">
                                    <p class="text-xs text-slate-400 mt-1">* Incluye 1 tetina por dosis</p>
                                </div>
                            </div>
                            
                            <!-- Agujas -->
                            <div class="flex items-center gap-4 group">
                                <div class="w-12 h-12 rounded-xl bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-400">
                                    <i data-lucide="syringe" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1">
                                    <label class="text-sm font-semibold text-slate-700 mb-1 block">Agujas</label>
                                    <input type="number" id="inp-agujas" value="1" min="0" oninput="calculate()" class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div class="space-y-6">
                    <div class="bg-gradient-to-br from-indigo-600 to-blue-700 text-white rounded-xl shadow-xl shadow-indigo-200 relative overflow-hidden border-none">
                        <i data-lucide="file-text" class="absolute top-0 right-0 w-32 h-32 opacity-10 transform rotate-12 m-4"></i>
                        
                        <div class="text-center py-8 relative z-10">
                            <h3 class="text-sm font-medium text-indigo-100 mb-2 uppercase tracking-widest">Costo Final</h3>
                            <div class="text-6xl font-bold mb-4 tracking-tighter" id="display-total">$0.00</div>
                            <div id="badge-min-cost" class="hidden inline-flex items-center gap-1.5 px-3 py-1.5 bg-white/10 backdrop-blur-sm border border-white/20 text-indigo-50 text-xs rounded-full font-medium">
                                <i data-lucide="info" class="w-3.5 h-3.5"></i> Costo mínimo aplicado
                            </div>
                        </div>

                        <div class="border-t border-white/10 px-6 py-4 bg-black/10 space-y-3 text-sm relative z-10">
                            <div class="flex justify-between text-indigo-100">
                                <span>Costos Fijos Base</span>
                                <span class="font-semibold text-white" id="display-fixed">$0.00</span>
                            </div>
                            <div class="flex justify-between text-indigo-100">
                                <span>Variables (Tinta/Agujas)</span>
                                <span class="font-semibold text-white" id="display-variable">$0.00</span>
                            </div>
                            <div class="flex justify-between text-indigo-100">
                                <span>Mano de Obra</span>
                                <span class="font-semibold text-white" id="display-time">$0.00</span>
                            </div>
                            <div class="flex justify-between text-indigo-100 pt-2 border-t border-white/5">
                                <span>Subtotal</span>
                                <span class="font-semibold text-white" id="display-subtotal">$0.00</span>
                            </div>
                            <div class="flex justify-between text-amber-300 font-medium">
                                <span>Impuestos / Extra</span>
                                <span id="display-tax-amt">$0.00</span>
                            </div>
                        </div>

                        <div class="p-4 bg-black/20 relative z-10">
                            <button onclick="openReport()" class="w-full py-3 bg-white text-indigo-700 rounded-lg font-bold hover:bg-indigo-50 transition-colors flex items-center justify-center gap-2 shadow-lg">
                                <i data-lucide="file-text" class="w-5 h-5"></i>
                                Generar Reporte / Imprimir
                            </button>
                        </div>
                    </div>

                    <!-- Config Impuestos -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center text-amber-600">
                            <i data-lucide="percent" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold uppercase text-slate-500 block mb-1">Impuestos (%)</label>
                            <input type="number" id="inp-tax-percent" value="0" min="0" oninput="calculate()" class="w-full px-3 py-1.5 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <button onclick="resetCalculator()" class="w-full flex items-center justify-center gap-2 py-4 bg-white border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 hover:text-indigo-600 hover:border-indigo-200 transition-all font-semibold shadow-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Reiniciar Calculadora
                    </button>
                </div>
            </div>
        </div>

        <!-- VISTA GESTIÓN INSUMOS -->
        <div id="view-supplies" class="space-y-8 fade-in hidden">
            <!-- Configuración Global -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex flex-col md:flex-row gap-8 items-center justify-between">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Costo Mínimo (Piso)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                            <input type="number" id="inp-min-cost" onchange="saveConfig()" class="w-full pl-7 pr-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-medium">
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Monto mínimo a cobrar.</p>
                    </div>
                    <div class="flex-1 w-full bg-slate-50 rounded-xl p-5 text-center border border-slate-200">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Costo Fijo Base</span>
                        <span class="text-3xl font-bold text-slate-800" id="supplies-fixed-display">$0.00</span>
                        <span class="text-xs text-slate-400 block mt-1">por sesión (Guantes, Servilletas, etc)</span>
                    </div>
                </div>
            </div>

            <!-- Formulario Agregar/Editar -->
            <div id="form-container" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden transition-all duration-300">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-slate-800" id="form-title">Agregar Nuevo Insumo</h3>
                    <button id="btn-cancel-edit" onclick="resetForm()" class="text-slate-400 hover:text-red-500 hidden"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-6">
                    <form id="supply-form" onsubmit="handleFormSubmit(event)" class="space-y-5">
                        <input type="hidden" id="edit-index" value="-1">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-6">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Nombre</label>
                                <input type="text" id="frm-name" required class="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Precio Paquete ($)</label>
                                <input type="number" step="0.01" id="frm-price" required class="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">Rendimiento (Cant.)</label>
                                <input type="number" id="frm-quantity" required class="w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="submit" id="btn-submit" class="px-6 py-2.5 rounded-lg flex items-center gap-2 font-medium text-white shadow-sm bg-slate-800 hover:bg-slate-900 transition-all">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Agregar a la Lista
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabla -->
            <div class="space-y-4">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="file-spreadsheet" class="w-5 h-5 text-green-600"></i> Tabla de Insumos
                    </h2>
                    
                    <div class="flex flex-wrap gap-2 items-center">
                        <!-- Botones de Respaldo -->
                        <button onclick="exportJSON()" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-indigo-700 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 transition-colors" title="Guardar copia de seguridad">
                            <i data-lucide="save" class="w-4 h-4"></i> <span class="hidden sm:inline">Respaldo JSON</span>
                        </button>
                        
                        <label class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 cursor-pointer" title="Restaurar copia de seguridad">
                            <i data-lucide="upload" class="w-4 h-4"></i> <span class="hidden sm:inline">Importar JSON</span>
                            <input type="file" onchange="importJSON(event)" accept=".json" class="hidden">
                        </label>

                        <div class="w-px h-6 bg-slate-300 mx-1 hidden sm:block"></div>

                        <!-- Exportar Excel -->
                        <button onclick="exportCSV()" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-green-700 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors" title="Descargar tabla para Excel">
                            <i data-lucide="sheet" class="w-4 h-4"></i> <span class="hidden sm:inline">Exportar Excel</span>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto border border-slate-200 rounded-xl shadow-sm bg-white">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500">
                            <tr>
                                <th class="px-5 py-4">Insumo</th>
                                <th class="px-5 py-4 text-right">Precio Total</th>
                                <th class="px-5 py-4 text-center">Rendimiento</th>
                                <th class="px-5 py-4 text-right text-indigo-600">Costo Unitario</th>
                                <th class="px-5 py-4 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="supplies-table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- MODAL DE REPORTE -->
    <div id="report-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm overflow-y-auto" onclick="closeModal(event)">
        <div id="report-content" class="bg-white w-full max-w-3xl rounded-xl shadow-2xl overflow-hidden relative fade-in" onclick="event.stopPropagation()">
            <!-- Header Modal -->
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center no-print sticky top-0 z-10">
                <h2 class="font-bold text-slate-700">Vista Previa del Reporte</h2>
                <div class="flex gap-2">
                    <button onclick="window.print()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-sm shadow-sm">
                        <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
                    </button>
                    <button onclick="closeModal()" class="p-2 bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>

            <!-- Hoja Reporte -->
            <div class="p-8 md:p-12 bg-white min-h-[20cm] text-slate-900 font-sans">
                <div class="flex justify-between items-start mb-12 border-b-2 border-slate-900 pb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900 uppercase tracking-tight">Reporte de Costos</h1>
                        <p class="text-slate-500 mt-1">Estimación de Tatuaje</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-indigo-600">InkCost Pro</div>
                        <p class="text-sm text-slate-400">@dr.velazquez</p>
                        <p class="text-sm font-medium text-slate-600 mt-2" id="report-date">--/--/----</p>
                    </div>
                </div>

                <div class="mb-10 p-6 bg-slate-50 rounded-lg border border-slate-100">
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Cliente</span>
                            <div class="h-6 border-b border-slate-300 w-full"></div>
                        </div>
                        <div>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Descripción / Zona</span>
                            <div class="h-6 border-b border-slate-300 w-full"></div>
                        </div>
                    </div>
                </div>

                <div class="mb-10">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-indigo-600 rounded-full"></span> Desglose
                    </h3>
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100 text-slate-500 font-bold uppercase text-xs">
                            <tr>
                                <th class="px-4 py-3 text-left">Concepto</th>
                                <th class="px-4 py-3 text-center">Detalle</th>
                                <th class="px-4 py-3 text-right">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr>
                                <td class="px-4 py-3 font-medium text-slate-700">Costos Fijos</td>
                                <td class="px-4 py-3 text-center text-slate-500">Insumos base (guantes, etc)</td>
                                <td class="px-4 py-3 text-right font-medium" id="rep-fixed">$0.00</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-slate-700">Mano de Obra</td>
                                <td class="px-4 py-3 text-center text-slate-500" id="rep-time-detail">0 min @ $0/hr</td>
                                <td class="px-4 py-3 text-right font-medium" id="rep-time-cost">$0.00</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-slate-700">Insumos Variables</td>
                                <td class="px-4 py-3 text-center text-slate-500" id="rep-vars-detail">...</td>
                                <td class="px-4 py-3 text-right font-medium" id="rep-vars-cost">$0.00</td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3 font-medium text-slate-700">Impuestos / Extra</td>
                                <td class="px-4 py-3 text-center text-slate-500" id="rep-tax-detail">0%</td>
                                <td class="px-4 py-3 text-right font-medium" id="rep-tax-cost">$0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end mb-12">
                    <div class="w-1/2">
                        <div class="flex justify-between py-2 border-b border-slate-200 text-slate-500">
                            <span>Subtotal Calculado</span>
                            <span id="rep-subtotal">$0.00</span>
                        </div>
                        <div id="rep-min-row" class="hidden flex justify-between py-2 border-b border-slate-200 text-amber-600 font-medium text-xs">
                            <span>* Ajuste Costo Mínimo</span>
                            <span>Aplicado</span>
                        </div>
                        <div class="flex justify-between py-4 items-center">
                            <span class="text-xl font-bold text-slate-900">Costo Total</span>
                            <span class="text-3xl font-bold text-indigo-600" id="rep-total">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // CONFIGURACIÓN
        const SPECIAL_VARS = ["Tinta", "Tetinas", "Agujas"];
        const INITIAL_DATA = [
            { nombre: "Agujas", precioTotal: 30.00, cantidad: 20 },
            { nombre: "Alcohol en gel", precioTotal: 3.00, cantidad: 30 },
            { nombre: "Bajalenguas (x100u)", precioTotal: 3.00, cantidad: 100 },
            { nombre: "Bolsitas cubregrip (x100)", precioTotal: 7.50, cantidad: 100 },
            { nombre: "Botella aplicadora", precioTotal: 2.00, cantidad: 100 },
            { nombre: "Desinfectante superficies", precioTotal: 5.00, cantidad: 5 },
            { nombre: "Gillette (5 u)", precioTotal: 2.50, cantidad: 5 },
            { nombre: "Termocopiadora", precioTotal: 90.00, cantidad: 200 },
            { nombre: "Guantes nitrilo", precioTotal: 6.00, cantidad: 100 },
            { nombre: "Jabón verde", precioTotal: 5.00, cantidad: 10 },
            { nombre: "Papel film 15m", precioTotal: 3.00, cantidad: 5 },
            { nombre: "Papel Hectografico (1 hoja)", precioTotal: 2.00, cantidad: 1 },
            { nombre: "Parche Epidermico (3x20cm)", precioTotal: 1.80, cantidad: 9 },
            { nombre: "Rollo grip", precioTotal: 1.00, cantidad: 3 },
            { nombre: "Servilletas (3rollos)", precioTotal: 3.00, cantidad: 8 },
            { nombre: "Stencil Stuff", precioTotal: 20.00, cantidad: 50 },
            { nombre: "Tetinas", precioTotal: 2.00, cantidad: 100 },
            { nombre: "Tinta", precioTotal: 15.00, cantidad: 20 },
            { nombre: "Vaselina", precioTotal: 2.00, cantidad: 50 }
        ];

        let supplies = JSON.parse(localStorage.getItem('inkcost_supplies')) || INITIAL_DATA;
        let minCost = parseFloat(localStorage.getItem('inkcost_min_cost')) || 15;
        let hourlyRate = parseFloat(localStorage.getItem('inkcost_hourly_rate')) || 6.00;
        let taxRate = parseFloat(localStorage.getItem('inkcost_tax_rate')) || 0;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            document.getElementById('inp-hourly-rate').value = hourlyRate;
            document.getElementById('inp-min-cost').value = minCost;
            document.getElementById('inp-tax-percent').value = taxRate;
            renderSuppliesTable();
            calculate();
        });

        function switchTab(tab) {
            const btnCalc = document.getElementById('btn-tab-calc');
            const btnSupp = document.getElementById('btn-tab-supplies');
            const viewCalc = document.getElementById('view-calculator');
            const viewSupp = document.getElementById('view-supplies');

            if (tab === 'calculator') {
                viewCalc.classList.remove('hidden'); viewSupp.classList.add('hidden');
                btnCalc.classList.add('bg-white','text-indigo-600','shadow-sm','ring-1','ring-black/5'); btnCalc.classList.remove('text-slate-500');
                btnSupp.classList.remove('bg-white','text-indigo-600','shadow-sm','ring-1','ring-black/5'); btnSupp.classList.add('text-slate-500');
            } else {
                viewCalc.classList.add('hidden'); viewSupp.classList.remove('hidden');
                btnSupp.classList.add('bg-white','text-indigo-600','shadow-sm','ring-1','ring-black/5'); btnSupp.classList.remove('text-slate-500');
                btnCalc.classList.remove('bg-white','text-indigo-600','shadow-sm','ring-1','ring-black/5'); btnCalc.classList.add('text-slate-500');
            }
        }

        function getCostPerUnit(name) {
            const item = supplies.find(s => s.nombre === name);
            return (item && item.cantidad > 0) ? item.precioTotal / item.cantidad : 0;
        }

        function calculate() {
            const rate = parseFloat(document.getElementById('inp-hourly-rate').value) || 0;
            const tax = parseFloat(document.getElementById('inp-tax-percent').value) || 0;
            localStorage.setItem('inkcost_hourly_rate', rate);
            localStorage.setItem('inkcost_tax_rate', tax);

            const minutes = parseFloat(document.getElementById('inp-minutes').value) || 0;
            const qTinta = parseFloat(document.getElementById('inp-tinta').value) || 0;
            const qAgujas = parseFloat(document.getElementById('inp-agujas').value) || 0;
            const qTetinas = qTinta; // Lógica implícita

            // Costo Fijo (excluyendo especiales)
            const fixed = supplies.filter(s => !SPECIAL_VARS.includes(s.nombre))
                .reduce((sum, item) => sum + (item.cantidad > 0 ? item.precioTotal / item.cantidad : 0), 0);

            // Variables
            const variableTotal = (qTinta * getCostPerUnit("Tinta")) + 
                                  (qTetinas * getCostPerUnit("Tetinas")) + 
                                  (qAgujas * getCostPerUnit("Agujas"));

            const timeCost = rate * (minutes / 60);
            const subtotal = fixed + variableTotal + timeCost;
            const taxAmount = subtotal * (tax / 100);
            const totalWithTax = subtotal + taxAmount;
            const finalTotal = Math.max(totalWithTax, minCost);
            const isMinApplied = finalTotal > totalWithTax;

            document.getElementById('display-total').innerText = `$${finalTotal.toFixed(2)}`;
            document.getElementById('display-fixed').innerText = `$${fixed.toFixed(2)}`;
            document.getElementById('display-variable').innerText = `$${variableTotal.toFixed(2)}`;
            document.getElementById('display-time').innerText = `$${timeCost.toFixed(2)}`;
            document.getElementById('display-subtotal').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('display-tax-amt').innerText = `+$${taxAmount.toFixed(2)}`;
            
            const badge = document.getElementById('badge-min-cost');
            if(isMinApplied) badge.classList.remove('hidden'); else badge.classList.add('hidden');
        }

        function resetCalculator() {
            document.getElementById('inp-minutes').value = 0;
            document.getElementById('inp-tinta').value = 1;
            document.getElementById('inp-agujas').value = 1;
            calculate();
        }

        function saveConfig() {
            const val = parseFloat(document.getElementById('inp-min-cost').value) || 0;
            localStorage.setItem('inkcost_min_cost', val);
            minCost = val;
            calculate();
        }

        function renderSuppliesTable() {
            const tbody = document.getElementById('supplies-table-body');
            tbody.innerHTML = '';
            
            const specials = supplies.filter(s => SPECIAL_VARS.includes(s.nombre));
            const others = supplies.filter(s => !SPECIAL_VARS.includes(s.nombre)).sort((a,b) => a.nombre.localeCompare(b.nombre));
            const sorted = [...specials, ...others];

            const fixed = supplies.filter(s => !SPECIAL_VARS.includes(s.nombre))
                .reduce((sum, item) => sum + (item.cantidad > 0 ? item.precioTotal / item.cantidad : 0), 0);
            document.getElementById('supplies-fixed-display').innerText = `$${fixed.toFixed(2)}`;

            sorted.forEach(item => {
                const isSpecial = SPECIAL_VARS.includes(item.nombre);
                const unitCost = item.cantidad > 0 ? item.precioTotal / item.cantidad : 0;
                const originalIndex = supplies.indexOf(item); 
                const tr = document.createElement('tr');
                tr.className = `group hover:bg-slate-50 transition-colors ${isSpecial ? 'bg-amber-50/30' : ''}`;
                tr.innerHTML = `
                    <td class="px-5 py-3 font-medium text-slate-800">
                        <div class="flex items-center gap-2">
                            ${item.nombre}
                            ${isSpecial ? '<span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-100 text-amber-700 border border-amber-200">VAR</span>' : ''}
                        </div>
                    </td>
                    <td class="px-5 py-3 text-right text-slate-600">$${item.precioTotal.toFixed(2)}</td>
                    <td class="px-5 py-3 text-center"><span class="inline-block px-2 py-1 bg-slate-100 rounded text-slate-600 text-xs font-semibold">${item.cantidad} u.</span></td>
                    <td class="px-5 py-3 text-right font-bold text-indigo-600">$${unitCost.toFixed(4)}</td>
                    <td class="px-5 py-3 text-center">
                        <div class="flex justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editSupply(${originalIndex})" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            ${!isSpecial ? `<button onclick="deleteSupply(${originalIndex})" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
            calculate();
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('frm-name').value;
            const price = parseFloat(document.getElementById('frm-price').value) || 0;
            const qty = parseFloat(document.getElementById('frm-quantity').value) || 0;
            const index = parseInt(document.getElementById('edit-index').value);

            if (index >= 0) {
                if (SPECIAL_VARS.includes(supplies[index].nombre)) {
                    supplies[index] = { ...supplies[index], precioTotal: price, cantidad: qty };
                } else {
                    supplies[index] = { nombre: name, precioTotal: price, cantidad: qty };
                }
            } else {
                supplies.push({ nombre: name, precioTotal: price, cantidad: qty });
            }
            localStorage.setItem('inkcost_supplies', JSON.stringify(supplies));
            resetForm();
            renderSuppliesTable();
        }

        function editSupply(index) {
            const item = supplies[index];
            document.getElementById('frm-name').value = item.nombre;
            document.getElementById('frm-name').disabled = SPECIAL_VARS.includes(item.nombre);
            document.getElementById('frm-price').value = item.precioTotal;
            document.getElementById('frm-quantity').value = item.cantidad;
            document.getElementById('edit-index').value = index;
            document.getElementById('form-title').innerText = "Editar Insumo";
            document.getElementById('btn-submit').innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Guardar Cambios`;
            document.getElementById('btn-submit').classList.remove('bg-slate-800');
            document.getElementById('btn-submit').classList.add('bg-indigo-600');
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('form-container').classList.add('ring-2', 'ring-indigo-500');
            lucide.createIcons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteSupply(index) {
            if(confirm("¿Eliminar insumo?")) {
                supplies.splice(index, 1);
                localStorage.setItem('inkcost_supplies', JSON.stringify(supplies));
                renderSuppliesTable();
            }
        }

        function resetForm() {
            document.getElementById('supply-form').reset();
            document.getElementById('edit-index').value = -1;
            document.getElementById('frm-name').disabled = false;
            document.getElementById('form-title').innerText = "Agregar Nuevo Insumo";
            document.getElementById('btn-submit').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i> Agregar a la Lista`;
            document.getElementById('btn-submit').classList.add('bg-slate-800');
            document.getElementById('btn-submit').classList.remove('bg-indigo-600');
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('form-container').classList.remove('ring-2', 'ring-indigo-500');
            lucide.createIcons();
        }

        // --- EXPORTAR / IMPORTAR CORREGIDO ---
        function exportJSON() {
            const jsonString = JSON.stringify(supplies, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "respaldo_inkcost.json";
            a.click();
        }

        function exportCSV() {
            const headers = ["Nombre", "Precio Total", "Cantidad", "Costo Unitario"];
            const rows = supplies.map(i => `"${i.nombre}",${i.precioTotal},${i.cantidad},${(i.cantidad>0?i.precioTotal/i.cantidad:0).toFixed(4)}`);
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'insumos.csv'; a.click();
        }

        function importJSON(e) {
            const file = e.target.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if(Array.isArray(data)) {
                        const valid = data.every(i => 'nombre' in i && 'precioTotal' in i && 'cantidad' in i);
                        if (valid) {
                            supplies = data;
                            localStorage.setItem('inkcost_supplies', JSON.stringify(supplies));
                            renderSuppliesTable();
                            alert('¡Respaldo restaurado correctamente!');
                        } else {
                            alert('El archivo JSON no tiene el formato correcto.');
                        }
                    }
                } catch(err) { alert('Error: Archivo inválido.'); }
            };
            r.readAsText(file);
        }

        function openReport() {
            const min = parseFloat(document.getElementById('inp-minutes').value) || 0;
            const rate = parseFloat(document.getElementById('inp-hourly-rate').value) || 0;
            document.getElementById('report-date').innerText = new Date().toLocaleDateString();
            document.getElementById('rep-fixed').innerText = document.getElementById('display-fixed').innerText;
            document.getElementById('rep-time-detail').innerText = `${min} min @ $${rate}/hr`;
            document.getElementById('rep-time-cost').innerText = document.getElementById('display-time').innerText;
            const qTin = document.getElementById('inp-tinta').value;
            const qAgu = document.getElementById('inp-agujas').value;
            document.getElementById('rep-vars-detail').innerText = `Tinta/Tetinas: ${qTin} dosis, Agujas: ${qAgu}`;
            document.getElementById('rep-vars-cost').innerText = document.getElementById('display-variable').innerText;
            const taxP = document.getElementById('inp-tax-percent').value;
            document.getElementById('rep-tax-detail').innerText = `${taxP}%`;
            document.getElementById('rep-tax-cost').innerText = document.getElementById('display-tax-amt').innerText;
            document.getElementById('rep-subtotal').innerText = document.getElementById('display-subtotal').innerText;
            document.getElementById('rep-total').innerText = document.getElementById('display-total').innerText;
            const badgeVisible = !document.getElementById('badge-min-cost').classList.contains('hidden');
            if(badgeVisible) document.getElementById('rep-min-row').classList.remove('hidden'); else document.getElementById('rep-min-row').classList.add('hidden');
            document.getElementById('report-modal').classList.remove('hidden');
        }

        function closeModal(e) {
            if (e && e.target !== e.currentTarget && e.target.closest('#report-content')) return;
            document.getElementById('report-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
